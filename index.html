<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·ä¹ æƒ¯è¯„åˆ†è¡¨</title>
    <style>
        body {
            font-family: 'å¾®è½¯é›…é»‘', sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #4CAF50;
            text-align: center;
        }

        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .ranking-container {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: none;
            /* åˆå§‹éšè— */
        }

        .weekly-summary {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #eee;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="checkbox"] {
            margin-right: 5px;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        #showRankingBtn {
            background-color: #47a84a;
        }

        #generateChartBtn {
            background-color: #3498db;
        }

        button:hover {
            background-color: #3e8e41;
        }

        .backup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #score {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        #feedback {
            margin-top: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        #chartContainer {
            width: 95%;          /* å®¹å™¨å®½åº¦ */
            height: 500px;       /* å®¹å™¨é«˜åº¦ */
            margin: 5px auto 0; /* ä¸Šè¾¹è·ï¼š5px, å·¦å³ï¼šauto, ä¸‹è¾¹è·ï¼š0 */  /* è°ƒæ•´è¿™é‡Œ */
            display: none;      /* åˆå§‹éšè— */
        }

        #scoreChart {
            max-width: 100%;
            height: 100%;        /* è®©å›¾è¡¨å¡«å……å®¹å™¨ */
        }

        #importFile {
            display: none;
            /* éšè—æ–‡ä»¶é€‰æ‹©æ¡† */
        }

        /* è¡¨æƒ…æ ·å¼ */
        .emoji {
            position: fixed;
            /* å›ºå®šå®šä½ */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            /* å¢å¤§è¡¨æƒ…å¤§å° */
            z-index: 1000;
            /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            display: none;
            /* åˆå§‹éšè— */
        }

        /* å“­è„¸ */
        .cry {
            animation: shake 0.5s infinite;
        }

        /* æ— è¡¨æƒ…è„¸ */
        .neutral {
            animation: pulse 1s infinite;
        }

        /* ç¬‘è„¸ */
        .smile {
            animation: bounce 0.5s infinite;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes shake {

            0%, 100% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            25% {
                transform: translate(-50%, -50%) rotate(-5deg);
            }

            75% {
                transform: translate(-50%, -50%) rotate(5deg);
            }
        }

        @keyframes pulse {

            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        @keyframes bounce {

            0%, 20%, 50%, 80%, 100% {
                transform: translate(-50%, -50%) translateY(0);
            }

            40% {
                transform: translate(-50%, -50%) translateY(-10px);
            }

            60% {
                transform: translate(-50%, -50%) translateY(-5px);
            }
        }

        /* çƒŸèŠ±å®¹å™¨ */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* ä¸å“åº”é¼ æ ‡äº‹ä»¶ */
            z-index: 999;
            /* åœ¨è¡¨æƒ…ä¸‹æ–¹ */
            display: none;
        }

        /* åª’ä½“æŸ¥è¯¢ï¼Œç”¨äºé€‚é…å°å±å¹•è®¾å¤‡ */
        @media (max-width: 600px) {
            #chartContainer {
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¥åº·ä¹ æƒ¯è¯„åˆ†è¡¨</h1>
        <p>ä»Šå¤©æ˜¯ï¼š<span id="currentDate"></span></p>
        <label for="weightInput">ä»Šæ—¥ä½“é‡ (kg):</label>
        <input type="number" id="weightInput" min="0" step="0.1" placeholder="è¯·è¾“å…¥ä½“é‡">
        <h2>è¿åŠ¨è§„åˆ’ (æ€»åˆ†: 50)</h2>
        <div>
            <label><input type="checkbox" data-score="15" data-label="æ™¨é—´è‡ªé‡å¾ªç¯"> æ™¨é—´30åˆ†é’Ÿè‡ªé‡å¾ªç¯ (15åˆ†)</label>
            <label><input type="checkbox" data-score="10" data-label="åˆåå±å¹•ä¸­æ–­è®­ç»ƒ"> åˆå20åˆ†é’Ÿå±å¹•ä¸­æ–­è®­ç»ƒ (10åˆ†)</label>
            <label><input type="checkbox" data-score="10" data-label="å‚æ™šæ­£å¿µè¡Œèµ°"> å‚æ™š40åˆ†é’Ÿæ­£å¿µè¡Œèµ° (10åˆ†)</label>
            <label><input type="checkbox" data-score="5" data-label="è¿åŠ¨ä¸å°¼å¤ä¸ä¾èµ–æ—¶æ®µé‡å "> è¿åŠ¨æ—¶æ®µä¸å°¼å¤ä¸ä¾èµ–æ—¶æ®µé‡å  (5åˆ†)</label>
            <label><input type="checkbox" data-score="10" data-label="5%é©å‘½åŸåˆ™"> é‡‡ç”¨"5%é©å‘½"åŸåˆ™ (10åˆ†)</label>
        </div>

        <h2>é¥®é£Ÿè§„åˆ’ (æ€»åˆ†: 50)</h2>
        <div>
            <label><input type="checkbox" data-score="15" data-label="äº”æ„Ÿé¥®é£Ÿæ³•"> å®æ–½"äº”æ„Ÿé¥®é£Ÿæ³•" (15åˆ†)</label>
            <label><input type="checkbox" data-score="15" data-label="è›‹ç™½è´¨å‰ç½®"> è›‹ç™½è´¨å‰ç½® (15åˆ†)</label>
            <label><input type="checkbox" data-score="10" data-label="å¼ºåˆ¶å•ä»»åŠ¡è¿›é£Ÿ"> å¼ºåˆ¶å•ä»»åŠ¡è¿›é£Ÿ (10åˆ†)</label>
            <label><input type="checkbox" data-score="10" data-label="æš´é£Ÿè½¬ä¸ºçŸ­è§†é¢‘"> æš´é£Ÿæ—¶æ®µè½¬ä¸ºçŸ­è§†é¢‘åˆ›ä½œ (10åˆ†)</label>
        </div>


        <button onclick="calculateScore()">è®¡ç®—æ€»åˆ†</button>
        <button id="showRankingBtn" onclick="showRanking()">æŸ¥çœ‹å®Œæˆè®°å½•</button>
        <button id="generateChartBtn" onclick="updateChartData()">ç”Ÿæˆç½‘çŠ¶å›¾</button>
        <div class="backup-buttons">
            <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            <button onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(this)">
        </div>
        <div id="result">
            <p>æ€»åˆ†: <span id="score">0</span></p>
            <p id="feedback"></p>
        </div>
        <!-- ç½‘çŠ¶å›¾å®¹å™¨ (ç§»å‡º #result) -->
        <div id="chartContainer">
            <canvas id="scoreChart"></canvas>
        </div>
        <div class="ranking-container" id="rankingContainer">
            <h2>å®Œæˆè®°å½•</h2>
            <div class="weekly-summary" id="weeklySummary">
                <p>æœ¬å‘¨æ€»å¾—åˆ†ï¼š<span id="weeklyTotalScore">0</span></p>
                <p>æœ¬å‘¨å¹³å‡å®Œæˆåº¦ï¼š<span id="weeklyAverageCompletion">0</span>%</p>
            </div>
            <div id="rankingContent"></div>
        </div>
    </div>

    <!-- è¡¨æƒ… -->
    <div class="emoji cry" id="cryEmoji">ğŸ˜­</div>
    <div class="emoji neutral" id="neutralEmoji">ğŸ˜</div>
    <div class="emoji smile" id="smileEmoji">ğŸ˜„</div>

    <!-- çƒŸèŠ±å®¹å™¨ -->
    <div class="fireworks-container" id="fireworksContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // è·å– canvas å…ƒç´ 
        const ctx = document.getElementById('scoreChart').getContext('2d');
        // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„å…¨å±€ Chart å¯¹è±¡
        let myChart = null;

        const apiId = '10002866';
        const apiKey = 'ec90ba12096a04176621ba4a46d8f609';
        const baseUrl = "https://cn.apihz.cn/api/time/getapi.php";

        // è·å–åŒ—äº¬æ—¶é—´ (ä»…ç”¨äºåˆå§‹åŒ–æ—¥æœŸ)
        async function getBeijingTime() {
            const apiUrl = `${baseUrl}?id=${apiId}&key=${apiKey}&type=1`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error("æ— æ³•è·å–åŒ—äº¬æ—¶é—´");
                }
                const text = await response.text();
                const data = JSON.parse(text);
                if (data && data.msg) {
                    const timestamp = parseInt(data.msg, 10);
                    if (!isNaN(timestamp)) {
                        return new Date(timestamp * 1000);
                    }
                }
            } catch (error) {
                console.error("è·å–åŒ—äº¬æ—¶é—´å¤±è´¥:", error);
                return null; // å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å› null
            }
        }

        // æ›´æ–°æ—¥æœŸçš„å‡½æ•°
        async function updateCurrentDate() {
            let today = await getBeijingTime(); // å°è¯•è·å–åŒ—äº¬æ—¶é—´
            if (!today) {
                today = new Date(); // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´
            }

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');

            const formattedDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
            document.getElementById('currentDate').textContent = formattedDate;

            checkAndResetData(); // æ£€æŸ¥å¹¶é‡ç½®æ•°æ®
        }

        // é¡µé¢åŠ è½½æ—¶é¦–æ¬¡æ›´æ–°æ—¥æœŸ
        updateCurrentDate();

        // è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨æ¯å¤© 00:00 æ›´æ–°æ—¥æœŸ
        function setNextDayUpdate() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºæ˜å¤©çš„ 00:00:00

            const timeUntilTomorrow = tomorrow - now; // è®¡ç®—æ—¶é—´å·®ï¼ˆæ¯«ç§’ï¼‰

            setTimeout(() => {
                updateCurrentDate();
                setNextDayUpdate(); // é€’å½’è°ƒç”¨ï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡æ›´æ–°
            }, timeUntilTomorrow);
        }

        setNextDayUpdate(); // å¯åŠ¨å®šæ—¶æ›´æ–°

        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™æ¸…ç©ºå½“æ—¥çš„å·²é€‰é¡¹ç›®å’Œåˆ†æ•°ã€‚
        function checkAndResetData() {
            const storedDate = localStorage.getItem('lastDate');
            const currentDate = new Date().toLocaleDateString();

            if (storedDate !== currentDate) {
                // æ—¥æœŸå·²æ›´æ”¹ï¼Œé‡ç½®å¤é€‰æ¡†ã€åˆ†æ•°å’Œä½“é‡
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                document.getElementById('score').textContent = '0';
                document.getElementById('weightInput').value = ''; // æ¸…ç©ºä½“é‡
                initChart(); // é‡ç½®å›¾è¡¨,è¿™é‡Œè°ƒç”¨æ— å‚çš„initChart

                // æ›´æ–°å­˜å‚¨çš„æ—¥æœŸ,å¹¶æ¸…é™¤åˆ†æ•°
                localStorage.setItem('lastDate', currentDate);
                localStorage.removeItem('dailyScores');
            }
        }

        // è®¡ç®—æ€»åˆ†
        function calculateScore() {
            let totalScore = 0;
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    totalScore += parseInt(checkbox.dataset.score);
                }
            });

            document.getElementById('score').textContent = totalScore;

            // åé¦ˆæ–‡æœ¬ (æ ¹æ®æ‚¨çš„è¦æ±‚ä¿®æ”¹)
            let feedbackText = "";
            if (totalScore < 60) {
                feedbackText = "å–‚ï¼Œæˆ‘è¯´ï¼Œä½ è¿™åˆ†æ•°ä¹Ÿå¤ªéš¾çœ‹äº†å§ï¼Ÿæ˜¯ä¸æ˜¯æŠŠå¥åº·å½“å„¿æˆå‘¢ï¼Ÿä¸è¿‡ï¼Œä¹Ÿåˆ«ç°å¿ƒï¼Œè¿™ä¸è¿˜æ²¡æ”¾å¼ƒå˜›ã€‚è®°ä½ï¼Œæ”¹å˜ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ï¼Œæ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼Œæ€»æ¯”åŸåœ°è¸æ­¥å¼ºï¼";
                showEmoji('cry');
            } else if (totalScore >= 60 && totalScore <= 75) {
                feedbackText = "å—¯ï¼Œæœ‰è¿›æ­¥ï¼Œä½†è¿˜ä¸å¤Ÿï¼ä½ è¿™åˆ†æ•°ä¸ä¸Šä¸ä¸‹çš„ï¼Œå°±åƒæ¸©åæ°´ä¸€æ ·ï¼Œæ²¡åŠ²ï¼å†åŠ æŠŠåŠ²ï¼ŒæŠŠé‚£äº›æ²¡å®Œæˆçš„é¡¹ç›®éƒ½å•ƒä¸‹æ¥ã€‚è®°ä½ï¼ŒåšæŒæ‰æ˜¯ç‹é“ï¼";
                showEmoji('neutral');
            } else {
                feedbackText = "å“‡ï¼å¹²å¾—æ¼‚äº®ï¼ä½ è¿™åˆ†æ•°ç®€ç›´é—ªçæˆ‘çš„çœ¼ï¼ç»§ç»­ä¿æŒè¿™ç§åŠ¿å¤´ï¼Œä½ å°±æ˜¯å¥åº·è¾¾äººï¼ä¸è¿‡ï¼Œä¹Ÿåˆ«éª„å‚²å“¦ï¼Œç»§ç»­åŠªåŠ›ï¼Œè®©å¥åº·æˆä¸ºä½ æœ€äº®çœ¼çš„æ ‡ç­¾ï¼";
                showEmoji('smile');
                showFireworks(); // æ˜¾ç¤ºçƒŸèŠ±
            }
            document.getElementById('feedback').textContent = feedbackText;

            // ä¿å­˜åˆ†æ•°å’Œä½“é‡
            saveScore(totalScore);

            // æ»šåŠ¨åˆ°æ€»åˆ†åŒºåŸŸ
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

 // åˆå§‹åŒ–å›¾è¡¨ (åˆ›å»ºå›¾è¡¨ï¼Œä½†ä¸å¡«å……æ•°æ®)
function initChart() {
    if (myChart) {
        return; // å¦‚æœå›¾è¡¨å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤åˆ›å»º
    }

    // è·å–æ‰€æœ‰å¤é€‰æ¡†çš„æ ‡ç­¾ä½œä¸ºå›¾è¡¨çš„æ ‡ç­¾,å¹¶é€‚å½“æ¢è¡Œ
    const labels = Array.from(document.querySelectorAll('input[type="checkbox"]')).map(checkbox => {
        return checkbox.dataset.label;
    });

    const chartData = {
        labels: labels, // ä½¿ç”¨å¤é€‰æ¡†çš„æ ‡ç­¾
        datasets: [{
            label: 'å®Œæˆæƒ…å†µ',
            data: [], // åˆå§‹æ•°æ®ä¸ºç©º
            backgroundColor: 'rgba(76, 175, 80, 0.6)', // ç»¿è‰²
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 1,
            pointBackgroundColor: 'rgba(76, 175, 80, 1)', // æ•°æ®ç‚¹é¢œè‰²
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(76, 175, 80, 1)'
        }]
    };

    const chartConfig = {
        type: 'radar', // é›·è¾¾å›¾
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                line: {
                    borderWidth: 3
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 15, // æ ¹æ®æœ€é«˜åˆ†è°ƒæ•´
                    min: 0,
                    ticks: {
                        stepSize: 5, // æ›´ç²¾ç»†çš„åˆ»åº¦
                        font:{
                            size:12 //è®¾ç½®åˆ»åº¦å­—ä½“å¤§å°
                        }
                    },
                    pointLabels: {
                        display: true, // æ˜¾ç¤ºæ ‡ç­¾
                        padding: 5,    // æ ‡ç­¾ä¸å›¾è¡¨çš„é—´è·
                        font: {
                            size: 10      // æ ‡ç­¾å­—ä½“å¤§å°
                        },
                        backdropPadding: 2, // æ ‡ç­¾èƒŒæ™¯çš„å†…è¾¹è·
                    }
                }
            },
            plugins: {
                legend: {
                    display: false, // ä¸æ˜¾ç¤ºå›¾ä¾‹
                },
                tooltip: {
                    bodyFont: {
                        size: 10
                    }
                }
            }
        }
    };

    myChart = new Chart(ctx, chartConfig); // åˆ›å»ºå›¾è¡¨

    //åœ¨æ¯æ¬¡å›¾è¡¨æ›´æ–°åæ‰§è¡Œ
    myChart.options.afterUpdate = function() {
        const canvas = myChart.canvas;
        const width = canvas.width;
        const height = canvas.height;
        const ctx = canvas.getContext('2d');

        ctx.save();
        ctx.translate(width / 2, height / 2);
        ctx.rotate(-Math.PI / 2); // é€†æ—¶é’ˆæ—‹è½¬90åº¦ï¼Œå› ä¸ºé›·è¾¾å›¾çš„0åº¦åœ¨å³ä¾§

        myChart.data.labels.forEach((label, i) => {
            const angle = (i * 2 * Math.PI / myChart.data.labels.length);
            const point = {
                x: (myChart.scales.r.getDistanceFromCenterForValue(myChart.scales.r.max) * Math.cos(angle)),
                y: (myChart.scales.r.getDistanceFromCenterForValue(myChart.scales.r.max) * Math.sin(angle))
            };

            ctx.font = '10px "å¾®è½¯é›…é»‘", sans-serif'; // è®¾ç½®å­—ä½“
            ctx.fillStyle = '#666'; // è®¾ç½®å­—ä½“é¢œè‰²
            

            // å°†æ ‡ç­¾åˆ†å‰²æˆå¤šè¡Œ
            const words = label.split('');
            const maxCharsPerLine = 8; // æ¯è¡Œæœ€å¤šå­—ç¬¦æ•° (æ ¹æ®éœ€è¦è°ƒæ•´)
            const lines = [];
            let currentLine = '';

            for (const word of words) {
                if (currentLine.length + word.length <= maxCharsPerLine) {
                    currentLine += word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine); // æ·»åŠ æœ€åä¸€è¡Œ

             // æ ¹æ®è§’åº¦è°ƒæ•´æ–‡æœ¬å¯¹é½æ–¹å¼
            if (angle > Math.PI / 2 && angle < 3 * Math.PI / 2) {
                ctx.textAlign = 'right';
                point.x -= 5; // å‘å·¦åç§»ä¸€ç‚¹
            }else if(angle > 3 * Math.PI / 2 || angle < Math.PI / 2){
                ctx.textAlign = 'left';
                point.x += 5; // å‘å·¦åç§»ä¸€ç‚¹
            }else{
                 ctx.textAlign = 'center'; // æ°´å¹³å±…ä¸­
            }
           
            ctx.textBaseline = 'middle'; // å‚ç›´å±…ä¸­
            // ç»˜åˆ¶å¤šè¡Œæ–‡æœ¬
            const lineHeight = 12; // è¡Œé«˜ (æ ¹æ®éœ€è¦è°ƒæ•´)
            const startY = point.y - (lines.length - 1) * lineHeight / 2; // è®¡ç®—ç¬¬ä¸€è¡Œçš„ y åæ ‡

            for (let j = 0; j < lines.length; j++) {
                ctx.fillText(lines[j], point.x, startY + j * lineHeight);
            }
        });
        ctx.restore();
    };
}

        // æ›´æ–°å›¾è¡¨æ•°æ® (ç‚¹å‡»æŒ‰é’®æ—¶è°ƒç”¨)
        function updateChartData() {
            // è·å–æ¯ä¸ªå¤é€‰æ¡†çš„å¾—åˆ†ï¼Œå¦‚æœæœªé€‰ä¸­åˆ™ä¸º 0, é€‰ä¸­åˆ™ä¸ºæ»¡åˆ†
            const checkboxData = Array.from(document.querySelectorAll('input[type="checkbox"]')).map(checkbox => checkbox.checked ? parseInt(checkbox.dataset.score) : 0);

            if (!myChart) {
                initChart(); // å¦‚æœå›¾è¡¨æœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–ï¼ˆä½†æ•°æ®å·²ç»åœ¨ä¸Šé¢å‡†å¤‡å¥½äº†ï¼‰
            }

            myChart.data.datasets[0].data = checkboxData; // æ›´æ–°æ•°æ®
            myChart.update(); // æ›´æ–°å›¾è¡¨

            // æ˜¾ç¤ºå›¾è¡¨å¹¶æ»šåŠ¨åˆ°å›¾è¡¨ä½ç½®
            document.getElementById('chartContainer').style.display = 'block';

            // ç¡®ä¿å›¾è¡¨å·²ç»æ¸²æŸ“å®Œæˆï¼Œå†è¿›è¡Œæ»šåŠ¨è®¡ç®—
            setTimeout(() => {
                const chartContainerRect = document.getElementById('chartContainer').getBoundingClientRect();
                const scrollTarget = chartContainerRect.top + window.pageYOffset + (chartContainerRect.height / 2) - (window.innerHeight / 2);
                window.scrollTo({
                    top: scrollTarget,
                    behavior: 'smooth'
                });
            }, 100); // ç¨å¾®å»¶è¿Ÿ 100 æ¯«ç§’
        }
       // ä¿å­˜åˆ†æ•°å’Œä½“é‡
        function saveScore(score) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            let scores = localStorage.getItem('dailyScores');
            scores = scores ? JSON.parse(scores) : {};

            const weight = parseFloat(document.getElementById('weightInput').value);

            scores[dateStr] = {
                score: score,
                weight: isNaN(weight) ? null : weight
            };

            localStorage.setItem('dailyScores', JSON.stringify(scores));
        }

        // æ˜¾ç¤ºå®Œæˆè®°å½•ï¼ˆæ’è¡Œæ¦œï¼‰
        function showRanking() {
            const rankingContainer = document.getElementById('rankingContainer');
            if (rankingContainer.style.display !== 'none') {
                // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™å…ˆéšè—
                rankingContainer.style.display = 'none';
            } else {
                // å¦‚æœæœªæ˜¾ç¤ºï¼Œåˆ™å…ˆæ˜¾ç¤ºï¼Œå†è®¡ç®—æ•°æ®å’Œæ»šåŠ¨
                rankingContainer.style.display = 'block';
                displayRanking(); // è°ƒç”¨ displayRanking å‡½æ•°æ¥ç”Ÿæˆè¡¨æ ¼
                calculateAndDisplayWeeklySummary();
                // æ»šåŠ¨åˆ°ç»Ÿè®¡è¡¨
                document.getElementById('rankingContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }
        // è·å–å¹¶æ˜¾ç¤ºæ’å
        function displayRanking() {
            const rankingContent = document.getElementById('rankingContent');
            rankingContent.innerHTML = ''; //æ¸…ç©ºä¹‹å‰çš„å†…å®¹

            //ä»localStorageä¸­è·å–æ‰€æœ‰åˆ†æ•°æ•°æ®
            let scores = localStorage.getItem('dailyScores');
            scores = scores ? JSON.parse(scores) : {};

            //å°†åˆ†æ•°æ•°æ®è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¹¶æŒ‰æ—¥æœŸæ’åº
            const scoreArray = Object.entries(scores).sort((a, b) => {
                return new Date(b[0]) - new Date(a[0]); //é™åºæ’åº
            });

            //è·å–å½“å‰æœˆä»½
            const currentMonth = new Date().getMonth() + 1;

            //ç­›é€‰å‡ºå½“æœˆçš„æ•°æ®
            const currentMonthScores = scoreArray.filter(([date, _]) => { // ä½¿ç”¨ _ å¿½ç•¥ä¸éœ€è¦çš„ score å‚æ•°
                const scoreMonth = new Date(date).getMonth() + 1;
                return scoreMonth === currentMonth;
            });

            if (currentMonthScores.length === 0) {
                rankingContent.textContent = "æœ¬æœˆæš‚æ— æ•°æ®";
                return;
            }


            //åˆ›å»ºè¡¨æ ¼å…ƒç´ 
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            //æ·»åŠ è¡¨å¤´
            const headerRow = document.createElement('tr');
            // ä¿®æ”¹è¡¨å¤´ï¼Œè°ƒæ•´åˆ—çš„é¡ºåº
            ['æ—¥æœŸ', 'å½“æ—¥ä½“é‡', 'å½“æ—¥å¾—åˆ†', 'å½“æ—¥å®Œæˆåº¦'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            //æ·»åŠ æ•°æ®è¡Œ
            currentMonthScores.forEach(([date, data]) => {
                const tr = document.createElement('tr');
                const dateCell = document.createElement('td');
                const weightCell = document.createElement('td'); // ä½“é‡
                const scoreCell = document.createElement('td'); // åˆ†æ•°
                const completionCell = document.createElement('td'); // å®Œæˆåº¦

                dateCell.textContent = date;
                weightCell.textContent = data.weight !== null ? data.weight : '-';
                scoreCell.textContent = data.score;

                // æ ¹æ®åˆ†æ•°è®¡ç®—å®Œæˆåº¦
                let completionText = '';
                if (data.score < 60) {
                    completionText = 'å¾ˆä½';
                } else if (data.score < 75) {
                    completionText = 'è¾ƒä½';
                } else if (data.score < 90) {
                    completionText = 'ä¸­ç­‰';
                } else if (data.score < 95) {
                    completionText = 'è‰¯å¥½';
                } else {
                    completionText = 'ä¼˜ç§€';
                }
                completionCell.textContent = completionText;

                tr.appendChild(dateCell);
                tr.appendChild(weightCell);
                tr.appendChild(scoreCell);
                tr.appendChild(completionCell);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            rankingContent.appendChild(table);

        }

        // è®¡ç®—å¹¶æ˜¾ç¤ºæ¯å‘¨æ€»ç»“
        function calculateAndDisplayWeeklySummary() {
            let scores = localStorage.getItem('dailyScores');
            scores = scores ? JSON.parse(scores) : {};

            // è·å–æœ¬å‘¨çš„èµ·å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 (å‘¨æ—¥) - 6 (å‘¨å…­)
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // å¦‚æœä»Šå¤©æ˜¯å‘¨æ—¥ï¼Œåˆ™ diff ä¸º -6ï¼Œå¦åˆ™ä¸º 1
            const startOfWeek = new Date(today.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©çš„ 00:00:00

            // è¿‡æ»¤å‡ºæœ¬å‘¨çš„æ•°æ®
            const weeklyScores = Object.entries(scores).filter(([date, _]) => {
                const recordDate = new Date(date);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate >= startOfWeek;
            });

            // è®¡ç®—æœ¬å‘¨æ€»å¾—åˆ†
            let weeklyTotalScore = 0;
            for (const [_, data] of weeklyScores) {
                weeklyTotalScore += data.score;
            }

            // è®¡ç®—æœ¬å‘¨å¹³å‡å®Œæˆåº¦
            const weeklyAverageCompletion = weeklyScores.length > 0 ? (weeklyTotalScore / (weeklyScores.length * 100)) * 100 : 0;

            // æ˜¾ç¤ºæœ¬å‘¨æ€»ç»“
            document.getElementById('weeklyTotalScore').textContent = weeklyTotalScore;
            document.getElementById('weeklyAverageCompletion').textContent = weeklyAverageCompletion.toFixed(2); //ä¿ç•™ä¸¤ä½å°æ•°
        }

       // å¯¼å‡ºä¸º CSV
        function exportData() {
            let scores = localStorage.getItem('dailyScores');
            if (!scores) {
                alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼");
                return;
            }

            scores = JSON.parse(scores);

            // CSV è¡¨å¤´
            let csvContent = "æ—¥æœŸ,ä½“é‡(kg),å¾—åˆ†,å®Œæˆåº¦\n";

            // CSV æ•°æ®è¡Œ
            for (const date in scores) {
                const data = scores[date];
                let completionText = '';
                if (data.score < 60) {
                    completionText = 'å¾ˆä½';
                } else if (data.score < 75) {
                    completionText = 'è¾ƒä½';
                } else if (data.score < 90) {
                    completionText = 'ä¸­ç­‰';
                } else if (data.score < 95) {
                    completionText = 'è‰¯å¥½';
                } else {
                    completionText = 'ä¼˜ç§€';
                }
                csvContent += `${date},${data.weight !== null ? data.weight : ''},${data.score},${completionText}\n`;
            }


            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "health_scores.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å¯¼å…¥æ•°æ®
        function importData(input) {
            const file = input.files[0];
            if (!file) {
                alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶ï¼");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    let currentScores = localStorage.getItem('dailyScores');
                    currentScores = currentScores ? JSON.parse(currentScores) : {};
                    const mergedScores = { ...currentScores, ...importedData };
                    localStorage.setItem('dailyScores', JSON.stringify(mergedScores));
                    alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼");
                    displayRanking(); // åˆ·æ–°æ’è¡Œæ¦œ
                    location.reload(); // é‡æ–°åŠ è½½é¡µé¢,ä¸ºäº†åˆ·æ–°å‘¨ç»Ÿè®¡ä¿¡æ¯
                } catch (error) {
                    alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„å¤‡ä»½æ–‡ä»¶ï¼");
                }
            };
            reader.readAsText(file);
        }
        // æ˜¾ç¤ºè¡¨æƒ…
        function showEmoji(type) {
            // å…ˆéšè—æ‰€æœ‰è¡¨æƒ…
            document.getElementById('cryEmoji').style.display = 'none';
            document.getElementById('neutralEmoji').style.display = 'none';
            document.getElementById('smileEmoji').style.display = 'none';

            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„è¡¨æƒ…
            if (type === 'cry') {
                document.getElementById('cryEmoji').style.display = 'block';
            } else if (type === 'neutral') {
                document.getElementById('neutralEmoji').style.display = 'block';
            } else if (type === 'smile') {
                document.getElementById('smileEmoji').style.display = 'block';
            }

            // 5 ç§’åéšè—è¡¨æƒ…
            setTimeout(() => {
                document.getElementById('cryEmoji').style.display = 'none';
                document.getElementById('neutralEmoji').style.display = 'none';
                document.getElementById('smileEmoji').style.display = 'none';
            }, 5000);
        }

        // æ˜¾ç¤ºçƒŸèŠ±
        function showFireworks() {
            document.getElementById('fireworksContainer').style.display = 'block';
            createFirework(); // åˆ›å»ºçƒŸèŠ±

            // 5 ç§’åéšè—çƒŸèŠ±å®¹å™¨
            setTimeout(() => {
                document.getElementById('fireworksContainer').style.display = 'none';
            }, 5000);
        }
        // é¡µé¢åŠ è½½å®Œæ¯•ååˆå§‹åŒ–å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            initChart(); // åˆå§‹æ—¶å®Œæˆåº¦ä¸º 0
        });
    </script>
    <!-- çƒŸèŠ±ç‰¹æ•ˆ (ä½¿ç”¨ JavaScript å’Œ Canvas å®ç°) -->
    <script>
        function createFirework() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.getElementById('fireworksContainer').appendChild(canvas);

            const particles = [];
            const colors = ['#FF5733', '#FFC300', '#C70039', '#900C3F', '#581845']; // çƒŸèŠ±é¢œè‰²

            // åˆ›å»ºç²’å­
            function createParticles(x, y) {
                const particleCount = 100; // ç²’å­æ•°é‡
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        radius: Math.random() * 5 + 1,
                                                velocityX: (Math.random() - 0.5) * 10,
                        velocityY: (Math.random() - 0.5) * 10,
                        alpha: 1
                    });
                }
            }

            // æ¸²æŸ“ç²’å­
            function renderParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…é™¤ç”»å¸ƒ
                particles.forEach((particle, index) => {
                    particle.x += particle.velocityX;
                    particle.y += particle.velocityY;
                    particle.alpha -= 0.01; // é€æ˜åº¦é€æ¸å‡å°

                    if (particle.alpha <= 0) {
                        particles.splice(index, 1); // ç§»é™¤æ¶ˆå¤±çš„ç²’å­
                    }

                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    ctx.fillStyle = particle.color;
                    ctx.globalAlpha = particle.alpha;
                    ctx.fill();
                });
            }
            // è®°å½•åŠ¨ç”»å¼€å§‹æ—¶é—´
            const startTime = Date.now();

            // æ›´æ–°åŠ¨ç”»
            function update() {
                if (Date.now() - startTime < 5000) {
                    renderParticles();
                    requestAnimationFrame(update);
                }else{
                    // ç§»é™¤canvas
                    document.getElementById('fireworksContainer').removeChild(canvas);
                }

            }
            // åœ¨å±å¹•ä¸­å¿ƒåˆ›å»ºçƒŸèŠ±
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            createParticles(x, y);
            update(); // å¯åŠ¨åŠ¨ç”»
        }
    </script>
</body>
</html>